# 実装計画: environment-configuration

## 概要

Healthmate プロダクト全体の環境設定とログ管理システムの段階的実装です。Core → HealthManager → CoachAI → Frontend の順序で、各サービスの環境設定を確実にテストしながら進めます。

## タスク

- [x] 1. Healthmate-Core: 共通環境設定モジュールの実装
  - 共通環境設定モジュール（Environment Manager、Configuration Provider、Log Controller）を作成
  - Cognito環境別設定の適用
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 2.4, 2.5, 4.1, 4.2, 8.1_

- [ ]* 1.1 Environment Manager のプロパティテストを実装
  - **プロパティ 1: 環境検証の一貫性**
  - **検証: 要件 1.1, 1.3, 1.4**

- [ ]* 1.2 Configuration Provider のプロパティテストを実装
  - **プロパティ 2: リソース名の環境別一意性**
  - **検証: 要件 3.4, 3.5, 3.6**

- [ ]* 1.3 Log Controller のプロパティテストを実装
  - **プロパティ 3: ログレベル階層の保持**
  - **検証: 要件 2.4, 2.5**

- [ ]* 1.4 環境設定の冪等性プロパティテストを実装
  - **プロパティ 4: 環境設定の冪等性**
  - **検証: 要件 4.1, 4.2**

- [ ]* 1.5 構造化ログのプロパティテストを実装
  - **プロパティ 5: 構造化ログの完全性**
  - **検証: 要件 5.1, 5.2, 5.5, 5.6**

- [x] 1.6 Healthmate-Core CDK スタックの環境別設定を適用
  - CDK スタックで環境別リソース名を使用
  - CloudFormation Export名の環境別設定
  - _要件: 3.1, 3.2, 3.3, 6.1, 6.2, 8.1_

- [ ]* 1.7 Healthmate-Core 単体テストを実装
  - 環境変数検証の単体テスト
  - Cognito設定の単体テスト
  - エラーハンドリングの単体テスト
  - _要件: 1.2, 2.1, 2.2, 2.3, 3.1, 5.3, 5.4_

- [x] 1.8 Healthmate-Core 環境別デプロイテスト
  - dev環境でのデプロイと動作確認
  - 環境設定ログの出力確認
  - _要件: 6.5, 9.2_

- [ ] 2. チェックポイント - Healthmate-Core 完了確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する

- [x] 3. Healthmate-HealthManager: 環境別設定の適用
  - DynamoDB テーブル名の環境別設定
  - Lambda 関数名の環境別設定
  - MCP Gateway の環境別設定
  - _要件: 3.4, 4.3, 8.2_

- [ ]* 3.1 HealthManager Lambda 関数の環境設定テストを実装
  - Lambda 関数での環境設定読み込みテスト
  - DynamoDB 接続の環境別テスト
  - _要件: 3.4, 8.2_

- [ ]* 3.2 MCP Gateway 環境設定のプロパティテストを実装
  - Gateway エンドポイントの環境別設定テスト
  - _要件: 3.6_

- [ ] 3.3 HealthManager CDK スタックの環境別設定を適用
  - DynamoDB テーブル名の環境別命名
  - Lambda 関数名の環境別命名
  - _要件: 3.4, 6.2, 8.2_

- [ ]* 3.4 HealthManager 統合テストを実装
  - Core サービスとの連携テスト
  - 環境設定の一貫性テスト
  - _要件: 4.2, 9.3_

- [x] 3.5 HealthManager 環境別動作確認
  - dev環境でのMCP動作テスト
  - 環境別DynamoDB接続確認
  - _要件: 9.3_

- [x] 4. チェックポイント - Healthmate-HealthManager 完了確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する

- [x] 5. Healthmate-CoachAI: 環境別設定の適用
  - AgentCore 環境別設定
  - IAM ロール名の環境別設定
  - MCP クライアント環境設定
  - _要件: 4.5, 8.3_

- [ ]* 5.1 AgentCore 環境設定のプロパティテストを実装
  - AgentCore デプロイ設定の環境別テスト
  - IAM ロール名の環境別テスト
  - _要件: 8.3_

- [x] 5.2 CoachAI AgentCore 設定ファイルの環境別対応
  - .bedrock_agentcore.yaml の環境別設定
  - メモリID の環境別設定
  - _要件: 8.3_

- [ ]* 5.3 CoachAI MCP クライアント環境設定テストを実装
  - MCP Gateway エンドポイントの環境別接続テスト
  - JWT トークン処理の環境別テスト
  - _要件: 3.6, 4.5_

- [ ]* 5.4 CoachAI 統合テストを実装
  - HealthManager サービスとの MCP 連携テスト
  - 環境別エージェント動作テスト
  - _要件: 9.4_

- [x] 5.5 CoachAI 環境別デプロイと動作確認
  - dev環境でのAgentCore デプロイ
  - 環境別MCP連携確認
  - _要件: 9.4_

- [x] 6. チェックポイント - Healthmate-CoachAI 完了確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する

- [x] 7. Healthmate-Frontend: 環境別設定の適用
  - 環境別ビルド設定
  - API エンドポイント環境設定
  - Cognito 環境別設定
  - _要件: 4.6, 8.4_

- [ ]* 7.1 Frontend 環境設定のプロパティテストを実装
  - 環境変数ファイルの読み込みテスト
  - API エンドポイント設定の環境別テスト
  - _要件: 3.5, 3.6, 8.4, 8.5_

- [x] 7.2 Frontend 環境変数ファイル管理の実装
  - .env.dev、.env.stage、.env.prod ファイルの作成
  - ビルド時の環境別設定読み込み
  - _要件: 8.4, 8.5_

- [ ]* 7.3 Frontend 統合テストを実装
  - 全サービス統合での環境別動作テスト
  - E2E 環境別フローテスト
  - _要件: 9.5_

- [x] 7.4 Frontend 環境別ビルドと動作確認
  - dev環境での全サービス統合テスト
  - 環境別設定の動作確認
  - _要件: 9.5_

- [ ] 8. 最終チェックポイント - 全サービス統合確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する

- [ ] 9. 後方互換性とデプロイ検証の実装
  - レガシー設定サポートの実装
  - デプロイ時検証機能の実装
  - 移行ガイドの作成
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 6.3, 6.4_

- [ ]* 9.1 後方互換性のプロパティテストを実装
  - **プロパティ 7: 後方互換性の保持**
  - **検証: 要件 7.2, 7.4, 7.5**

- [ ]* 9.2 デプロイ検証のプロパティテストを実装
  - **プロパティ 6: デプロイ検証の確実性**
  - **検証: 要件 6.1, 6.2, 6.3, 6.4, 6.5**

- [ ]* 9.3 移行テストを実装
  - レガシー設定から新設定への移行テスト
  - データ保持の確認テスト
  - _要件: 7.1, 7.3, 7.5_

- [x] 10. 文書化
  - 環境設定ガイドの作成
  - 運用手順書の作成
  - _要件: 9.1, 9.6_

## 注意事項

- `*` マークのタスクはオプションで、コア機能の実装を優先してMVPを早く完成させることができます
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントでは段階的な検証を行い、問題があれば前の段階に戻って修正します
- プロパティテストは普遍的な正確性プロパティを検証します
- 単体テストは特定の例とエッジケースを検証します